<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<div class="layout" [class.light]="temaClaro">

  <nav class="navbar-top d-flex align-items-center px-3">
    <div class="d-flex align-items-center">
      <h4 class="m-0">Gerenciador de Tarefas</h4>
    </div>

    <div class="ms-auto d-flex align-items-center gap-2">
      <ng-container *ngIf="!usuarioLogado; else logado">
        <button class="btn btn-outline-light btn-sm" (click)="mudarAba('login')">Login</button>
        <button class="btn btn-outline-light btn-sm" (click)="mudarAba('cadastro')">Cadastro</button>
      </ng-container>
      <ng-template #logado>
        <button class="btn btn-danger btn-sm" (click)="sair()">Sair</button>
      </ng-template>
    </div>
  </nav>

  <aside class="sidebar d-flex flex-column">
    <div>
      <button (click)="mudarAba('cadastrar')" [class.active]="aba==='cadastrar'">
        {{ modoEdicao ? 'Editando Tarefa' : 'Cadastrar Tarefa' }}
      </button>
      <button (click)="mudarAba('todas')" [class.active]="aba==='todas'">Tarefas Cadastradas</button>

      <div class="sub" *ngIf="aba==='todas' || aba==='concluidas' || aba==='abertas'">
        <button (click)="mudarAba('concluidas')" [class.active]="aba==='concluidas'">Concluídas</button>
        <button (click)="mudarAba('abertas')" [class.active]="aba==='abertas'">Abertas</button>
      </div>
    </div>

    <div class="sidebar-footer mt-auto">
      <ng-container *ngIf="usuarioLogado; else semUser">
        <div class="d-flex align-items-center gap-2 small">
          <b>{{usuarioLogado.nome}} {{usuarioLogado.sobrenome}}</b>
          <button class="btn btn-outline-light btn-sm p-1" (click)="mudarAba('config')">⚙</button>
        </div>
      </ng-container>

      <ng-template #semUser>
        <div class="small text-muted">Não conectado</div>
      </ng-template>
    </div>
  </aside>

  <main class="conteudo">

    <section *ngIf="aba==='login'" class="centro">
      <form class="card-tarefas" (ngSubmit)="login()">
        <h4 class="text-center mb-3">Login</h4>
        <input class="form-control mb-1" placeholder="Email" [(ngModel)]="loginEmail" name="e" required>
        <div *ngIf="erroLoginEmail" class="text-danger small">Email incorreto</div>

        <input type="password" class="form-control mt-2" placeholder="Senha" [(ngModel)]="loginSenha" name="s" required>
        <div *ngIf="erroLoginSenha" class="text-danger small">Senha incorreta</div>

        <button class="btn btn-primary w-100 mt-3">Entrar</button>
      </form>
    </section>

    <section *ngIf="aba==='cadastro'" class="centro">
      <form class="card-tarefas" (ngSubmit)="salvarUsuario()" #form="ngForm" novalidate>
        <h4 class="text-center mb-3">Cadastro</h4>

        <div class="mb-2">
          <input class="form-control" placeholder="Nome" [(ngModel)]="usuario.nome" name="n" required>
          <div *ngIf="erroNome" class="invalid-feedback d-block">Nome obrigatório</div>
        </div>

        <div class="mb-2">
          <input class="form-control" placeholder="Sobrenome" [(ngModel)]="usuario.sobrenome" name="sn" required>
          <div *ngIf="erroSobrenome" class="invalid-feedback d-block">Sobrenome obrigatório</div>
        </div>

        <div class="mb-2">
          <input class="form-control" type="number" placeholder="Idade" [(ngModel)]="usuario.idade" name="i" required>
          <div *ngIf="erroIdade" class="invalid-feedback d-block">Idade inválida</div>
        </div>

        <div class="mb-2">
          <input class="form-control" type="email" placeholder="Email" [(ngModel)]="usuario.email" name="email"
            required>
          <div *ngIf="erroEmail" class="invalid-feedback d-block">Email inválido</div>
          <div *ngIf="erroEmailExistente" class="alert alert-warning mt-1 p-1">Email já cadastrado</div>
        </div>

        <div class="mb-3">
          <input class="form-control" type="password" placeholder="Senha (min 5 caracteres)" [(ngModel)]="usuario.senha"
            name="senha" required>
          <div *ngIf="erroSenha" class="invalid-feedback d-block">Senha inválida</div>
        </div>

        <button class="btn btn-primary w-100">Salvar</button>
      </form>
    </section>


    <section *ngIf="aba==='config'" class="centro">
      <div class="card-tarefas text-center">
        <h4>Perfil</h4>
        <p *ngIf="usuarioLogado"><b>{{usuarioLogado.nome}} {{usuarioLogado.sobrenome}}</b></p>
        <p>Email: {{usuario.email}}</p>
        <p>Idade: {{usuario.idade}}</p>
        <hr>
        <button class="btn btn-secondary w-100 mb-2" (click)="alternarTema()">Tema:
          {{temaClaro?'Claro':'Escuro'}}</button>
        <button class="btn btn-danger w-100" (click)="sair()">Sair</button>
      </div>
    </section>

    <section *ngIf="aba==='cadastrar'" class="centro">
      <form (ngSubmit)="modoEdicao ? solicitarConfirmacaoEdicao(form) : adicionarTarefa(form)" #form="ngForm"
        class="card-tarefas">
        <h4 class="text-center mb-3">{{ modoEdicao ? 'Editar Tarefa' : 'Nova Tarefa' }}</h4>

        <label>Título *</label>
        <input class="form-control mb-1" minlength="3" name="titulo" [(ngModel)]="novaTarefa.titulo" required>
        <div *ngIf="form.submitted && novaTarefa.titulo.trim().length < 3" class="text-danger small">Mínimo 3 letras
        </div>

        <label>Descrição</label>
        <textarea class="form-control mb-2" name="descricao" [(ngModel)]="novaTarefa.descricao"></textarea>

        <label>Data *</label>
        <input type="date" min="{{hoje}}" class="form-control mb-2" name="data" [(ngModel)]="novaTarefa.data" required>
        <div *ngIf="form.submitted && !novaTarefa.data" class="text-danger small">Data obrigatória</div>

        <button type="submit" class="btn btn-primary w-100 mt-2">
          {{modoEdicao ? "Salvar Alterações" : "Cadastrar"}}
        </button>

        <button *ngIf="modoEdicao" type="button" class="btn btn-secondary w-100 mt-2" (click)="cancelarEdicao()">
          Cancelar Edição
        </button>
      </form>
    </section>

    <section *ngIf="aba!=='login' && aba!=='cadastro' && aba!=='config' && aba!=='cadastrar'" class="centro">
      <table class="table table-hover tabela" [class.table-dark]="!temaClaro">
        <thead>
          <tr>
            <th>Título</th>
            <th>Descrição</th>
            <th>Data</th>
            <th>Status</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let tarefa of tarefasFiltradas(); let i=index">
            <td [class.ok]="tarefa.concluida">{{tarefa.titulo}}</td>
            <td [class.ok]="tarefa.concluida">{{tarefa.descricao}}</td>
            <td>{{tarefa.data}}</td>
            <td>
              <input type="checkbox" [checked]="tarefa.concluida" (change)="alternarStatus(i)">
              <span class="ms-1">Concluído</span>
            </td>

            <td>
              <button class="btn btn-warning btn-sm w-100 mb-2" (click)="editarTarefa(tarefa)">
                Editar
              </button>

              <button class="btn btn-sm btn-danger w-100" (click)="confirmarExclusao(tarefa)">
                Excluir
              </button>
            </td>
          </tr>

          <tr *ngIf="tarefasFiltradas().length===0">
            <td colspan="5" class="text-center">Nenhuma tarefa encontrada</td>
          </tr>
        </tbody>
      </table>
    </section>

    <div *ngIf="tarefaConfirmacaoEdicao" class="modal-backdrop">
      <div class="modal-card">
        <p>Confirmar alterações na tarefa <b>{{tarefaConfirmacaoEdicao.titulo}}</b>?</p>
        <div class="d-flex gap-2">
          <button class="btn btn-primary w-50" (click)="confirmarEdicao()">Confirmar</button>
          <button class="btn btn-secondary w-50" (click)="cancelarConfirmacaoEdicao()">Cancelar</button>
        </div>
      </div>
    </div>

    <div *ngIf="tarefaSelecionadaParaExcluir" class="modal-backdrop">
      <div class="modal-card">
        <p>Excluir <b>{{tarefaSelecionadaParaExcluir.titulo}}</b>?</p>
        <div class="d-flex gap-2">
          <button class="btn btn-danger w-50" (click)="excluirDefinitivo()">Excluir</button>
          <button class="btn btn-secondary w-50" (click)="cancelarExclusao()">Cancelar</button>
        </div>
      </div>
    </div>

  </main>
</div>